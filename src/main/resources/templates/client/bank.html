<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>RAVO Bank ê³„ì¢Œ</title>

    <!-- (ì„ íƒ) Spring Security CSRF ë©”íƒ€ -->
    <meta name="_csrf" th:content="${_csrf?.token}" />
    <meta name="_csrf_header" th:content="${_csrf?.headerName}" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

    <style>
        body { background:#f8f9fa; padding:2rem; font-family:'Segoe UI', system-ui, -apple-system, 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif; }
        .account-card { background:#fff; border-radius:16px; padding:2.5rem; box-shadow:0 4px 10px rgba(0,0,0,.06); width:min(720px, 92vw); margin:auto; }
        .username { font-size:1.1rem; font-weight:600; color:#333; }

        /* ìƒë‹¨ ì»¨íŠ¸ë¡¤/ìƒíƒœ */
        .control-bar { display:flex; flex-wrap:wrap; gap:.5rem; justify-content:center; margin-bottom:1rem; }
        .control-bar .btn { min-width:160px; }
        .status-pill { display:none; align-items:center; gap:.4rem; justify-content:center; margin-bottom:.75rem; }
        .status-pill.show { display:flex; }
        .status-pill .dot { width:8px; height:8px; border-radius:50%; background:#dc3545; animation: blink 1.1s infinite; }
        @keyframes blink { 50% { opacity:.3; } }

        /* ê³„ì¢Œë²ˆí˜¸ */
        .acct-row { display:flex; align-items:center; justify-content:space-between; gap:.75rem; }
        .acct-badge { font-weight:700; letter-spacing:.3px; padding:.35rem .65rem; border-radius:.65rem; background:#f1f3f5; border:1px solid #e9ecef; }
        .copy-btn { border:1px solid #e9ecef; background:#fff; width:40px; height:40px; border-radius:10px; display:flex; align-items:center; justify-content:center; }
        .copy-btn:hover { background:#f8f9fa; }

        .balance-area { display:flex; align-items:center; justify-content:center; gap:.5rem; margin:1.25rem 0 1.75rem; }
        .balance { font-size:2.4rem; font-weight:800; color:#111; margin:0; }

        /* ê±°ë˜ ì…ë ¥ í¼ */
        .tx-grid { display:grid; grid-template-columns: 1fr; gap:1rem; }
        .tx-box { display:flex; gap:.75rem; }
        .tx-input { flex:1; border-radius:12px; border:1px solid #ced4da; padding:.8rem 1rem; font-size:1rem; height:52px; }
        .btn-action { border:none; border-radius:12px; font-weight:700; min-width:140px; height:52px; font-size:1rem; }
        .btn-deposit { background:#e9ecef; color:#212529; }
        .btn-deposit:hover { background:#dee2e6; }
        .btn-withdraw, .btn-transfer { background:#ffcc00; color:#212529; }
        .btn-withdraw:hover, .btn-transfer:hover { background:#f1c40f; }

        .transfer-fields { display:grid; grid-template-columns:1fr 1fr; gap:.75rem; flex:1; }
        @media (max-width: 520px) { .transfer-fields { grid-template-columns:1fr; } }

        /* í† ìŠ¤íŠ¸ */
        .toast-fixed { position:fixed; right:24px; bottom:24px; z-index:1060; background:rgba(0,0,0,.85); color:#fff; padding:.75rem 1rem; border-radius:10px; font-size:.95rem; opacity:0; transform:translateY(10px); transition:all .25s ease; }
        .toast-fixed.show { opacity:1; transform:translateY(0); }

        /* ë¹„í™œì„±í™” ì‹œ ì‹œê°ì  í”¼ë“œë°± */
        .disabled { opacity:.6; cursor:not-allowed !important; }
    </style>
</head>
<body>
<div class="account-card">
    <p class="text-secondary mb-1">RAVO Bank</p>
    <p class="username" th:text="${username}">í™ê¸¸ë™</p>
    <hr/>

    <!-- âœ… ìƒíƒœ ë°°ì§€ -->
    <div id="statusPill" class="status-pill alert alert-warning py-2 mb-2">
        <span class="dot"></span>
        <strong id="statusTitle">ì•Œë¦¼</strong>
        <span id="statusText" class="ms-1">ìƒíƒœ ì•ˆë‚´</span>
    </div>

    <!-- âœ… ìƒë‹¨ ì»¨íŠ¸ë¡¤ -->
    <div class="control-bar">
        <button type="button" id="btnDown" class="btn btn-outline-danger btn-sm" onclick="ctrlActiveDb('down')">
            <i class="bi bi-plug-fill me-1"></i>Active DB Down
        </button>
        <button type="button" id="btnUp" class="btn btn-outline-success btn-sm" onclick="ctrlActiveDb('up')">
            <i class="bi bi-plug me-1"></i>Active DB Up
        </button>
        <button type="button" id="btnRefresh" class="btn btn-outline-secondary btn-sm" onclick="loadBalance(true)">
            <i class="bi bi-arrow-clockwise me-1"></i>ì”ì•¡ ìƒˆë¡œê³ ì¹¨
        </button>
    </div>

    <!-- âœ… ë‚´ ê³„ì¢Œë²ˆí˜¸ + ë³µì‚¬ -->
    <div class="acct-row mb-1">
        <span class="text-muted">ë‚´ ê³„ì¢Œë²ˆí˜¸</span>
    </div>
    <div class="acct-row mb-3">
        <span class="acct-badge" id="acctNo">-</span>
        <button type="button" class="copy-btn" id="copyBtn" onclick="copyAcctNo()" title="ê³„ì¢Œë²ˆí˜¸ ë³µì‚¬">
            <i class="bi bi-clipboard"></i>
        </button>
    </div>

    <!-- âœ… ì”ì•¡ -->
    <p class="text-muted mb-0">í˜„ì¬ ì”ì•¡</p>
    <div class="balance-area">
        <p class="balance mb-0"><span id="balance">-</span> ì›</p>
    </div>

    <!-- âœ… ê±°ë˜ í¼ (ë¹„ì°¨ë‹¨) -->
    <div class="tx-grid">
        <!-- ì…ê¸ˆ -->
        <div class="tx-box">
            <form id="formDeposit" class="w-100 d-flex">
                <input type="hidden" name="requestId" id="depRequestId" />
                <input type="text" name="amount" class="tx-input js-amount" placeholder="ì…ê¸ˆ ê¸ˆì•¡ (ì˜ˆ: 10,000)" inputmode="numeric" autocomplete="off" required />
                <button type="submit" class="btn btn-deposit btn-action ms-2">ì…ê¸ˆ</button>
            </form>
        </div>

        <!-- ì¶œê¸ˆ -->
        <div class="tx-box">
            <form id="formWithdraw" class="w-100 d-flex">
                <input type="hidden" name="requestId" id="wdRequestId" />
                <input type="text" name="amount" class="tx-input js-amount" placeholder="ì¶œê¸ˆ ê¸ˆì•¡ (ì˜ˆ: 5,000)" inputmode="numeric" autocomplete="off" required />
                <button type="submit" class="btn btn-withdraw btn-action ms-2">ì¶œê¸ˆ</button>
            </form>
        </div>

        <!-- ì†¡ê¸ˆ -->
        <div class="tx-box">
            <form id="formTransfer" class="w-100 d-flex">
                <input type="hidden" name="requestId" id="trfRequestId" />
                <div class="transfer-fields">
                    <input type="text" name="toAccountNo" class="tx-input" placeholder="ìˆ˜ì·¨ ê³„ì¢Œë²ˆí˜¸ (RAVO-****)" required />
                    <input type="text" name="amount" class="tx-input js-amount" placeholder="ì†¡ê¸ˆ ê¸ˆì•¡ (ì˜ˆ: 20,000)" inputmode="numeric" autocomplete="off" required />
                </div>
                <button type="submit" class="btn btn-transfer btn-action ms-2">ì†¡ê¸ˆ</button>
            </form>
        </div>
    </div>

    <!-- âœ… í† ìŠ¤íŠ¸ -->
    <div id="toast" class="toast-fixed"></div>

    <form method="get" action="/logout" class="mt-2">
        <button type="submit" class="btn btn-link text-secondary p-0">ë¡œê·¸ì•„ì›ƒ</button>
    </form>
</div>

<script>
    // ---- CSRF (ìˆëŠ” ê²½ìš°ì—ë§Œ ìë™ ì‚¬ìš©) ----
    const csrfToken  = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
    const baseHeaders = {'X-Requested-With':'XMLHttpRequest'};
    if (csrfHeader && csrfToken) baseHeaders[csrfHeader] = csrfToken;

    // ---- ìƒíƒœ í”Œë˜ê·¸ (ë°°ë„ˆ ì¶©ëŒ ë°©ì§€) ----
    let uiLocked = false;     // /ui/status ì—ì„œ ë‚´ë ¤ì˜¤ëŠ” ì „í™˜ ì ê¸ˆ ìƒíƒœ
    let failoverMode = false; // DB ì¥ì•  ìë™ ì¬ì‹œë„ ì¤‘ì¸ì§€ ì—¬ë¶€

    // ---- Helpers ----
    function rid(prefix){
      return (crypto?.randomUUID ? `${prefix}-${crypto.randomUUID()}` : `${prefix}-${Math.random().toString(16).slice(2)}${Date.now().toString(16)}`);
    }
    function showToast(msg){
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(()=> t.classList.remove('show'), 1800);
    }
    function formatAmount(n){
      if (n === null || n === undefined || n === '') return '';
      const num = typeof n === 'number' ? n : parseAmount(n);
      if (isNaN(num)) return '';
      return num.toLocaleString('ko-KR');
    }
    function parseAmount(str){
      if (typeof str === 'number') return str;
      const onlyDigits = String(str).replace(/[^\d]/g,'');
      return onlyDigits ? parseInt(onlyDigits, 10) : 0;
    }
    function setBalance(v){
      document.getElementById('balance').textContent = formatAmount(v);
    }
    function setAccountNo(v){ document.getElementById('acctNo').textContent = v || '-'; }

    // âœ… ìƒíƒœ ë°°ë„ˆë¥¼ ë¬¸êµ¬ì™€ í•¨ê»˜ ì œì–´
    function setStatusPill(on, titleText = '', descText = ''){
      const pill = document.getElementById('statusPill');
      const title = document.getElementById('statusTitle');
      const text  = document.getElementById('statusText');
      if (titleText) title.textContent = titleText;
      if (descText)  text.textContent  = `Â· ${descText}`;
      if (on) pill.classList.add('show'); else pill.classList.remove('show');
    }

    // âœ… ê¸ˆì•¡ ì…ë ¥ì°½(., ê³µë°± ë“± ì œê±° â†’ 3ìë¦¬ ì½¤ë§ˆ í¬ë§·)
    function bindAmountFormatter(){
      const inputs = document.querySelectorAll('.js-amount');
      inputs.forEach(inp=>{
        inp.addEventListener('input', ()=>{
          const raw = inp.value;
          const num = parseAmount(raw);
          inp.value = num ? num.toLocaleString('ko-KR') : '';
        });
        inp.addEventListener('blur', ()=>{
          if (inp.value.trim() === '') return;
          const num = parseAmount(inp.value);
          inp.value = num ? num.toLocaleString('ko-KR') : '';
        });
      });
    }

    // âœ… ê³µí†µ: ì—˜ë¦¬ë¨¼íŠ¸ enable/disable + ìŠ¤íƒ€ì¼
    function toggleEls(on, selectors){
      document.querySelectorAll(selectors.join(',')).forEach(el => {
        if (!el) return;
        el.disabled = !on;
        el.classList.toggle('disabled', !on);
        if (!on) el.setAttribute('aria-busy','true'); else el.removeAttribute('aria-busy');
      });
    }

    // âœ… ì „ì²´ ì¸í„°ë™ì…˜(ê¸ˆìœµ + ë³µì‚¬/ìƒˆë¡œê³ ì¹¨ + DB Up/Down) í† ê¸€
    function setAllInteractiveEnabled(on){
      const selectors = [
        // ê±°ë˜ í¼
        '#formDeposit input',  '#formDeposit button[type="submit"]',
        '#formWithdraw input', '#formWithdraw button[type="submit"]',
        '#formTransfer input', '#formTransfer button[type="submit"]',
        // ê¸°íƒ€
        '#copyBtn',
        '#btnRefresh',
        // DB ì œì–´
        '#btnDown',
        '#btnUp'
      ];
      toggleEls(on, selectors);
    }

    // âœ… ê¸ˆìœµ ê´€ë ¨(ê±°ë˜ í¼ + ë³µì‚¬/ìƒˆë¡œê³ ì¹¨)ë§Œ í† ê¸€
    function setFinanceActionsEnabled(on){
      const selectors = [
        '#formDeposit input',  '#formDeposit button[type="submit"]',
        '#formWithdraw input', '#formWithdraw button[type="submit"]',
        '#formTransfer input', '#formTransfer button[type="submit"]',
        '#copyBtn',
        '#btnRefresh'
      ];
      toggleEls(on, selectors);
    }

    // âœ… DB ì œì–´ ë²„íŠ¼(Up/Down)ë§Œ í† ê¸€ â€” ë¶€ë¶„ ë¹„í™œì„±í™”ì—ì„œ ì‚¬ìš©
    function setDbControlsEnabled(on){
      const selectors = ['#btnDown', '#btnUp'];
      toggleEls(on, selectors);
    }

    // âœ… Failover ì™„ë£Œ ëŒ€ê¸°: ë‚´ë¶€ í”„ë¡ì‹œ(/bank/failover/status) ê°ì‹œ â†’ watcher === 'standby' ì‹œ í™œì„±í™”
    async function waitForFailoverAndEnable(){
      failoverMode = true;
      setStatusPill(true, 'Failover ê°ì§€', 'ìë™ ì¬ì‹œë„ ì¤‘ì…ë‹ˆë‹¤. ì„œë¹„ìŠ¤ëŠ” ê³„ì† ì‹œë„ë©ë‹ˆë‹¤.');
      setAllInteractiveEnabled(false);      // ì „ì²´ ë¹„í™œì„±í™”

      const statusUrl = '/bank/failover/status'; // ë‚´ë¶€ ì—”ë“œí¬ì¸íŠ¸
      const maxWaitMs = 60000;
      const interval  = 800;
      const start     = Date.now();

      while (Date.now() - start < maxWaitMs){
        try {
          const res = await fetch(statusUrl, { headers: baseHeaders });
          if (res.ok) {
            const st = await res.json().catch(()=> ({}));
            const watcher = String(st?.watcher || '').toLowerCase();

            if (watcher === 'standby') {
              // ì”ì•¡/ê³„ì¢Œë²ˆí˜¸ ìµœì‹ í™”
              try {
                const data = await requestWithFailover('/bank/api/balance', { headers: baseHeaders }, 'ì”ì•¡ ì¡°íšŒ');
                if (data?.ok) {
                  setAccountNo(data.accountNo);
                  setBalance(data.balance);
                }
              } catch(_) { /* ì‹¤íŒ¨í•´ë„ ë¹„ì°¨ë‹¨ */ }

              if (!uiLocked) {
                setAllInteractiveEnabled(true);     // ì „ì²´ í™œì„±í™”
                setStatusPill(false);
                showToast('Failover ì™„ë£Œ(Standby ì „í™˜)');
              }
              failoverMode = false;
              return;
            }
          }
        } catch (_) { /* ë¬´ì‹œ í›„ ì¬ì‹œë„ */ }

        await new Promise(r => setTimeout(r, interval));
      }

      showToast('Failover ì§€ì—° Â· ìƒíƒœ ì „í™˜ì„ í™•ì¸í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤');
      failoverMode = false;
    }

    // ---- /ui/status í´ë§ : ë°±ì—”ë“œ ì „í™˜ ë½(LOCK/UNLOCK)ì— ë°˜ì‘ ----
    async function pollUiLockStatus(){
      try{
        const res  = await fetch('/ui/status', { headers: baseHeaders });
        const data = await res.json().catch(()=> ({}));
        const locked = !!data?.locked;

        if (locked !== uiLocked){
          uiLocked = locked;
          if (uiLocked){
            // ì „í™˜ ì§„í–‰ ì¤‘ ì ê¸ˆ
            setAllInteractiveEnabled(false);        // ì „ì²´ ë¹„í™œì„±í™”
            setStatusPill(true, 'ì‹œìŠ¤í…œ ì „í™˜ ì¤‘', 'ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.');
          } else {
            // ì „í™˜ í•´ì œ
            // failoverModeê°€ ì•„ë‹ˆë©´ ë°°ë„ˆ ë‚´ë¦¬ê³  ë²„íŠ¼ í™œì„±í™”
            if (!failoverMode) {
              setAllInteractiveEnabled(true);       // ì „ì²´ í™œì„±í™”
              setStatusPill(false);
              showToast('ì „í™˜ ì™„ë£Œ');
            }
          }
        }
      }catch(_){ /* í´ë§ ì‹¤íŒ¨ëŠ” ì¡°ìš©íˆ ë¬´ì‹œ */ }
    }

    async function ctrlActiveDb(act){
      const url = act === 'down' ? '/bank/active-db/down' : '/bank/active-db/up';
      try{
        const res  = await fetch(url, {method:'POST', headers: baseHeaders});
        const data = await res.json().catch(()=> ({}));
        if (!res.ok || data.ok === false) throw new Error(data.message || 'ìš”ì²­ ì‹¤íŒ¨');

        showToast(data.message || 'ì™„ë£Œ');

        if (act === 'down'){
          // ë‹¤ìš´ â†’ Failover ì™„ë£Œ ëŒ€ê¸°: ì „ì²´ ë¹„í™œì„±í™”
          waitForFailoverAndEnable();
        } else {
          // â¬†ï¸ ì—… í´ë¦­ ì‹œ: í˜„ì¬ standby ìƒíƒœë¼ë©´ Up/Downë§Œ ì„ ì œ ë¹„í™œì„±í™”
          try {
            const stRes = await fetch('/bank/failover/status', { headers: baseHeaders });
            if (stRes.ok) {
              const st = await stRes.json().catch(()=> ({}));
              const watcher = String(st?.watcher || '').toLowerCase();
              if (watcher === 'standby') {
                // ğŸ”’ ë¶€ë¶„ ë¹„í™œì„±í™”: DB ì œì–´ ë²„íŠ¼ë§Œ ë§‰ê¸°
                setDbControlsEnabled(false);
                setStatusPill(true, 'ì „í™˜ ì¤€ë¹„ ì¤‘', 'Active ë³µêµ¬ ë‹¨ê³„ì…ë‹ˆë‹¤.');
                // ì´í›„ managerê°€ /ui/status=locked ë¡œ ë°”ê¾¸ë©´ pollUiLockStatusê°€ ì „ì²´ ë¹„í™œì„±í™”ë¡œ ì „í™˜
              }
            }
          } catch(_) {}

          // ì”ì•¡ì€ ì‚´ì§ ì§€ì—° í›„ ê°±ì‹ (ì„ íƒ)
          setTimeout(()=> loadBalance(true), 700);
        }
      }catch(e){
        showToast('ìš”ì²­ ì‹¤íŒ¨: ' + e.message);
      }
    }

    setInterval(pollUiLockStatus, 500); // 0.5ì´ˆ ê°„ê²© í´ë§
    // ì´ˆê¸° 1íšŒ ì¦‰ì‹œ ì²´í¬
    pollUiLockStatus();

    // ---- ê³µí†µ ìš”ì²­(ìë™ ì¬ì‹œë„) ----
    async function requestWithFailover(url, options = {}, labelForToast = 'ìš”ì²­') {
      const maxRetries = 4;
      const baseDelay  = 500;
      let attempt = 0;

      while (true) {
        try {
          const res  = await fetch(url, options);
          const data = await res.json().catch(() => ({}));

          // âœ… ë¹„ì¦ˆë‹ˆìŠ¤ ì‹¤íŒ¨: 200 + { ok:false } â†’ ë°°ë„ˆ/ì¬ì‹œë„ X
          if (res.ok && data && data.ok === false) {
            return data;
          }

          // âœ… DB ì¥ì• ë§Œ failover ëª¨ë“œ
          const isDbFail =
            res.status === 503 || (data && data.error === 'DB_CONNECTION_ERROR');

          if (isDbFail) {
            attempt++;
            if (attempt === 1) {
              failoverMode = true;
              setStatusPill(true, 'Failover ê°ì§€', `${labelForToast} ì¬ì‹œë„ ì¤‘â€¦`);
            }
            if (attempt > maxRetries) {
              showToast(`${labelForToast} ì‹¤íŒ¨: DB ì¥ì• (ì¬ì‹œë„ ì´ˆê³¼)`);
              failoverMode = false;
              throw new Error(data?.message || 'DB ì¥ì• ');
            }
            const backoff = Math.round(baseDelay * Math.pow(1.6, attempt - 1));
            await new Promise(r => setTimeout(r, backoff));
            continue;
          }

          // âœ… ì„±ê³µ
          if (res.ok) {
            if (!uiLocked) setStatusPill(false); // ì ê¸ˆ ì¤‘ì´ë©´ ë°°ë„ˆ ìœ ì§€
            failoverMode = false;
            return data;
          }

          // âœ… ê¸°íƒ€ 4xx/5xx: ì¬ì‹œë„/ë°°ë„ˆ ì—†ì´
          showToast(data?.message || `${labelForToast} ì‹¤íŒ¨`);
          return data || { ok: false, message: `${labelForToast} ì‹¤íŒ¨` };

        } catch (e) {
          attempt++;
          if (attempt > maxRetries) {
            showToast(`${labelForToast} ì‹¤íŒ¨: ${e.message}`);
            failoverMode = false;
            throw e;
          }
          const backoff = Math.round(baseDelay * Math.pow(1.6, attempt - 1));
          await new Promise(r => setTimeout(r, backoff));
        }
      }
    }

    // ---- ì´ˆê¸°/ìˆ˜ë™ ì”ì•¡ ë¡œë“œ ----
    async function loadBalance(showMsg){
      try{
        const data = await requestWithFailover('/bank/api/balance', {headers: baseHeaders}, 'ì”ì•¡ ì¡°íšŒ');
        if (data?.ok) {
          setAccountNo(data.accountNo);
          setBalance(data.balance);
          if (showMsg) showToast('ì”ì•¡ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
      }catch(e){
        /* ì‹¤íŒ¨í•´ë„ ë¹„ì°¨ë‹¨ */
      }
    }

    // ---- ê³„ì¢Œë²ˆí˜¸ ë³µì‚¬ (ì•„ì´ì½˜ ì²´í¬ ì „í™˜) ----
    function copyAcctNo(){
      const txt = document.getElementById('acctNo')?.textContent?.trim();
      const icon = document.querySelector('#copyBtn i');
      if (!txt || !icon) return;
      navigator.clipboard.writeText(txt).then(()=>{
        icon.classList.replace('bi-clipboard','bi-check2');
        setTimeout(()=> icon.classList.replace('bi-check2','bi-clipboard'), 1200);
      });
    }

    // ---- ê±°ë˜ í¼ ë°”ì¸ë”© (ë¹„ì°¨ë‹¨ + ìë™ì¬ì‹œë„ + ê¸ˆì•¡ í¬ë§·/ì •ê·œí™”) ----
    (function(){
      bindAmountFormatter();

      const dep = document.getElementById('formDeposit');
      const wd  = document.getElementById('formWithdraw');
      const trf = document.getElementById('formTransfer');

      if(dep) dep.addEventListener('submit', async e=>{
        e.preventDefault();
        dep.querySelector('#depRequestId').value = rid('DEP');

        const amtInput = dep.querySelector('input[name="amount"]');
        const amount   = parseAmount(amtInput.value);
        if (!amount || amount <= 0){ showToast('ì…ê¸ˆ ê¸ˆì•¡ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”.'); return; }

        amtInput.value = String(amount);
        const fd = new FormData(dep);
        try{
          const data = await requestWithFailover('/bank/api/deposit', {method:'POST', headers: baseHeaders, body: fd}, 'ì…ê¸ˆ');
          if (data?.ok) {
            setBalance(data.balance);
            showToast(data.message || 'ì…ê¸ˆ ì™„ë£Œ');
            dep.reset();
            bindAmountFormatter();
          } else if (data?.message) {
            showToast(data.message);
          }
        }catch{ /* ì‹¤íŒ¨í•´ë„ ë¹„ì°¨ë‹¨ */ }
      });

      if(wd) wd.addEventListener('submit', async e=>{
        e.preventDefault();
        wd.querySelector('#wdRequestId').value = rid('WD');

        const amtInput = wd.querySelector('input[name="amount"]');
        const amount   = parseAmount(amtInput.value);
        if (!amount || amount <= 0){ showToast('ì¶œê¸ˆ ê¸ˆì•¡ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”.'); return; }

        amtInput.value = String(amount);
        const fd = new FormData(wd);
        try{
          const data = await requestWithFailover('/bank/api/withdraw', {method:'POST', headers: baseHeaders, body: fd}, 'ì¶œê¸ˆ');
          if (data?.ok === false){
            showToast(data.message || 'ì¶œê¸ˆ ì‹¤íŒ¨');
            return;
          }
          if (data?.ok){
            setBalance(data.balance);
            showToast(data.message || 'ì¶œê¸ˆ ì™„ë£Œ');
            wd.reset();
            bindAmountFormatter();
          }
        }catch{ /* ì‹¤íŒ¨í•´ë„ ë¹„ì°¨ë‹¨ */ }
      });

      if(trf) trf.addEventListener('submit', async e=>{
        e.preventDefault();
        trf.querySelector('#trfRequestId').value = rid('TRF');

        const amtInput = trf.querySelector('input[name="amount"]');
        const amount   = parseAmount(amtInput.value);
        if (!amount || amount <= 0){ showToast('ì†¡ê¸ˆ ê¸ˆì•¡ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”.'); return; }

        amtInput.value = String(amount);
        const fd = new FormData(trf);
        try{
          const data = await requestWithFailover('/bank/api/transfer', {method:'POST', headers: baseHeaders, body: fd}, 'ì†¡ê¸ˆ');
          if (data?.ok === false){
            showToast(data.message || 'ì†¡ê¸ˆ ì‹¤íŒ¨');
            return;
          }
          if (data?.ok){
            setBalance(data.balance);
            showToast(data.message || 'ì†¡ê¸ˆ ì™„ë£Œ');
            trf.reset();
            bindAmountFormatter();
          }
        }catch{ /* ì‹¤íŒ¨í•´ë„ ë¹„ì°¨ë‹¨ */ }
      });
    })();

    // ìµœì´ˆ ì§„ì… ì‹œ ì”ì•¡ ë¡œë“œ
    loadBalance(false);
</script>
</body>
</html>