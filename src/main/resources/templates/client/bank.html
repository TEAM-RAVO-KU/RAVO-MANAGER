<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>RAVO Bank 계좌</title>

    <!-- (선택) Spring Security CSRF 메타 -->
    <meta name="_csrf" th:content="${_csrf?.token}" />
    <meta name="_csrf_header" th:content="${_csrf?.headerName}" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

    <style>
        body { background:#f8f9fa; padding:2rem; font-family:'Segoe UI', system-ui, -apple-system, 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif; }
        .account-card { background:#fff; border-radius:16px; padding:2.5rem; box-shadow:0 4px 10px rgba(0,0,0,.06); width:min(720px, 92vw); margin:auto; }
        .username { font-size:1.1rem; font-weight:600; color:#333; }

        /* 상단 컨트롤/상태 */
        .control-bar { display:flex; flex-wrap:wrap; gap:.5rem; justify-content:center; margin-bottom:1rem; }
        .control-bar .btn { min-width:160px; }
        .status-pill { display:none; align-items:center; gap:.4rem; justify-content:center; margin-bottom:.75rem; }
        .status-pill.show { display:flex; }
        .status-pill .dot { width:8px; height:8px; border-radius:50%; background:#dc3545; animation: blink 1.1s infinite; }
        @keyframes blink { 50% { opacity:.3; } }

        /* 계좌번호 */
        .acct-row { display:flex; align-items:center; justify-content:space-between; gap:.75rem; }
        .acct-badge { font-weight:700; letter-spacing:.3px; padding:.35rem .65rem; border-radius:.65rem; background:#f1f3f5; border:1px solid #e9ecef; }
        .copy-btn { border:1px solid #e9ecef; background:#fff; width:40px; height:40px; border-radius:10px; display:flex; align-items:center; justify-content:center; }
        .copy-btn:hover { background:#f8f9fa; }

        .balance-area { display:flex; align-items:center; justify-content:center; gap:.5rem; margin:1.25rem 0 1.75rem; }
        .balance { font-size:2.4rem; font-weight:800; color:#111; margin:0; }

        /* 거래 입력 폼 */
        .tx-grid { display:grid; grid-template-columns: 1fr; gap:1rem; }
        .tx-box { display:flex; gap:.75rem; }
        .tx-input { flex:1; border-radius:12px; border:1px solid #ced4da; padding:.8rem 1rem; font-size:1rem; height:52px; }
        .btn-action { border:none; border-radius:12px; font-weight:700; min-width:140px; height:52px; font-size:1rem; }
        .btn-deposit { background:#e9ecef; color:#212529; }
        .btn-deposit:hover { background:#dee2e6; }
        .btn-withdraw, .btn-transfer { background:#ffcc00; color:#212529; }
        .btn-withdraw:hover, .btn-transfer:hover { background:#f1c40f; }

        .transfer-fields { display:grid; grid-template-columns:1fr 1fr; gap:.75rem; flex:1; }
        @media (max-width: 520px) { .transfer-fields { grid-template-columns:1fr; } }

        /* 토스트 */
        .toast-fixed { position:fixed; right:24px; bottom:24px; z-index:1060; background:rgba(0,0,0,.85); color:#fff; padding:.75rem 1rem; border-radius:10px; font-size:.95rem; opacity:0; transform:translateY(10px); transition:all .25s ease; }
        .toast-fixed.show { opacity:1; transform:translateY(0); }

        /* 비활성화 시 시각적 피드백 */
        .disabled { opacity:.6; cursor:not-allowed !important; }
    </style>
</head>
<body>
<div class="account-card">
    <p class="text-secondary mb-1">RAVO Bank</p>
    <p class="username" th:text="${username}">홍길동</p>
    <hr/>

    <!-- ✅ 상태 배지 -->
    <div id="statusPill" class="status-pill alert alert-warning py-2 mb-2">
        <span class="dot"></span>
        <strong id="statusTitle">알림</strong>
        <span id="statusText" class="ms-1">상태 안내</span>
    </div>

    <!-- ✅ 상단 컨트롤 -->
    <div class="control-bar">
        <button type="button" id="btnDown" class="btn btn-outline-danger btn-sm" onclick="ctrlActiveDb('down')">
            <i class="bi bi-plug-fill me-1"></i>Active DB Down
        </button>
        <button type="button" id="btnUp" class="btn btn-outline-success btn-sm" onclick="ctrlActiveDb('up')">
            <i class="bi bi-plug me-1"></i>Active DB Up
        </button>
        <button type="button" id="btnRefresh" class="btn btn-outline-secondary btn-sm" onclick="loadBalance(true)">
            <i class="bi bi-arrow-clockwise me-1"></i>잔액 새로고침
        </button>
    </div>

    <!-- ✅ 내 계좌번호 + 복사 -->
    <div class="acct-row mb-1">
        <span class="text-muted">내 계좌번호</span>
    </div>
    <div class="acct-row mb-3">
        <span class="acct-badge" id="acctNo">-</span>
        <button type="button" class="copy-btn" id="copyBtn" onclick="copyAcctNo()" title="계좌번호 복사">
            <i class="bi bi-clipboard"></i>
        </button>
    </div>

    <!-- ✅ 잔액 -->
    <p class="text-muted mb-0">현재 잔액</p>
    <div class="balance-area">
        <p class="balance mb-0"><span id="balance">-</span> 원</p>
    </div>

    <!-- ✅ 거래 폼 (비차단) -->
    <div class="tx-grid">
        <!-- 입금 -->
        <div class="tx-box">
            <form id="formDeposit" class="w-100 d-flex">
                <input type="hidden" name="requestId" id="depRequestId" />
                <input type="text" name="amount" class="tx-input js-amount" placeholder="입금 금액 (예: 10,000)" inputmode="numeric" autocomplete="off" required />
                <button type="submit" class="btn btn-deposit btn-action ms-2">입금</button>
            </form>
        </div>

        <!-- 출금 -->
        <div class="tx-box">
            <form id="formWithdraw" class="w-100 d-flex">
                <input type="hidden" name="requestId" id="wdRequestId" />
                <input type="text" name="amount" class="tx-input js-amount" placeholder="출금 금액 (예: 5,000)" inputmode="numeric" autocomplete="off" required />
                <button type="submit" class="btn btn-withdraw btn-action ms-2">출금</button>
            </form>
        </div>

        <!-- 송금 -->
        <div class="tx-box">
            <form id="formTransfer" class="w-100 d-flex">
                <input type="hidden" name="requestId" id="trfRequestId" />
                <div class="transfer-fields">
                    <input type="text" name="toAccountNo" class="tx-input" placeholder="수취 계좌번호 (RAVO-****)" required />
                    <input type="text" name="amount" class="tx-input js-amount" placeholder="송금 금액 (예: 20,000)" inputmode="numeric" autocomplete="off" required />
                </div>
                <button type="submit" class="btn btn-transfer btn-action ms-2">송금</button>
            </form>
        </div>
    </div>

    <!-- ✅ 토스트 -->
    <div id="toast" class="toast-fixed"></div>

    <form method="get" action="/logout" class="mt-2">
        <button type="submit" class="btn btn-link text-secondary p-0">로그아웃</button>
    </form>
</div>

<script>
    // ---- CSRF (있는 경우에만 자동 사용) ----
    const csrfToken  = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
    const baseHeaders = {'X-Requested-With':'XMLHttpRequest'};
    if (csrfHeader && csrfToken) baseHeaders[csrfHeader] = csrfToken;

    // ---- 상태 플래그 (배너 충돌 방지) ----
    let uiLocked = false;     // /ui/status 에서 내려오는 전환 잠금 상태
    let failoverMode = false; // DB 장애 자동 재시도 중인지 여부

    // ---- Helpers ----
    function rid(prefix){
      return (crypto?.randomUUID ? `${prefix}-${crypto.randomUUID()}` : `${prefix}-${Math.random().toString(16).slice(2)}${Date.now().toString(16)}`);
    }
    function showToast(msg){
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(()=> t.classList.remove('show'), 1800);
    }
    function formatAmount(n){
      if (n === null || n === undefined || n === '') return '';
      const num = typeof n === 'number' ? n : parseAmount(n);
      if (isNaN(num)) return '';
      return num.toLocaleString('ko-KR');
    }
    function parseAmount(str){
      if (typeof str === 'number') return str;
      const onlyDigits = String(str).replace(/[^\d]/g,'');
      return onlyDigits ? parseInt(onlyDigits, 10) : 0;
    }
    function setBalance(v){
      document.getElementById('balance').textContent = formatAmount(v);
    }
    function setAccountNo(v){ document.getElementById('acctNo').textContent = v || '-'; }

    // ✅ 상태 배너를 문구와 함께 제어
    function setStatusPill(on, titleText = '', descText = ''){
      const pill = document.getElementById('statusPill');
      const title = document.getElementById('statusTitle');
      const text  = document.getElementById('statusText');
      if (titleText) title.textContent = titleText;
      if (descText)  text.textContent  = `· ${descText}`;
      if (on) pill.classList.add('show'); else pill.classList.remove('show');
    }

    // ✅ 금액 입력창(., 공백 등 제거 → 3자리 콤마 포맷)
    function bindAmountFormatter(){
      const inputs = document.querySelectorAll('.js-amount');
      inputs.forEach(inp=>{
        inp.addEventListener('input', ()=>{
          const raw = inp.value;
          const num = parseAmount(raw);
          inp.value = num ? num.toLocaleString('ko-KR') : '';
        });
        inp.addEventListener('blur', ()=>{
          if (inp.value.trim() === '') return;
          const num = parseAmount(inp.value);
          inp.value = num ? num.toLocaleString('ko-KR') : '';
        });
      });
    }

    // ✅ 공통: 엘리먼트 enable/disable + 스타일
    function toggleEls(on, selectors){
      document.querySelectorAll(selectors.join(',')).forEach(el => {
        if (!el) return;
        el.disabled = !on;
        el.classList.toggle('disabled', !on);
        if (!on) el.setAttribute('aria-busy','true'); else el.removeAttribute('aria-busy');
      });
    }

    // ✅ 전체 인터랙션(금융 + 복사/새로고침 + DB Up/Down) 토글
    function setAllInteractiveEnabled(on){
      const selectors = [
        // 거래 폼
        '#formDeposit input',  '#formDeposit button[type="submit"]',
        '#formWithdraw input', '#formWithdraw button[type="submit"]',
        '#formTransfer input', '#formTransfer button[type="submit"]',
        // 기타
        '#copyBtn',
        '#btnRefresh',
        // DB 제어
        '#btnDown',
        '#btnUp'
      ];
      toggleEls(on, selectors);
    }

    // ✅ 금융 관련(거래 폼 + 복사/새로고침)만 토글
    function setFinanceActionsEnabled(on){
      const selectors = [
        '#formDeposit input',  '#formDeposit button[type="submit"]',
        '#formWithdraw input', '#formWithdraw button[type="submit"]',
        '#formTransfer input', '#formTransfer button[type="submit"]',
        '#copyBtn',
        '#btnRefresh'
      ];
      toggleEls(on, selectors);
    }

    // ✅ DB 제어 버튼(Up/Down)만 토글 — 부분 비활성화에서 사용
    function setDbControlsEnabled(on){
      const selectors = ['#btnDown', '#btnUp'];
      toggleEls(on, selectors);
    }

    // ✅ Failover 완료 대기: 내부 프록시(/bank/failover/status) 감시 → watcher === 'standby' 시 활성화
    async function waitForFailoverAndEnable(){
      failoverMode = true;
      setStatusPill(true, 'Failover 감지', '자동 재시도 중입니다. 서비스는 계속 시도됩니다.');
      setAllInteractiveEnabled(false);      // 전체 비활성화

      const statusUrl = '/bank/failover/status'; // 내부 엔드포인트
      const maxWaitMs = 60000;
      const interval  = 800;
      const start     = Date.now();

      while (Date.now() - start < maxWaitMs){
        try {
          const res = await fetch(statusUrl, { headers: baseHeaders });
          if (res.ok) {
            const st = await res.json().catch(()=> ({}));
            const watcher = String(st?.watcher || '').toLowerCase();

            if (watcher === 'standby') {
              // 잔액/계좌번호 최신화
              try {
                const data = await requestWithFailover('/bank/api/balance', { headers: baseHeaders }, '잔액 조회');
                if (data?.ok) {
                  setAccountNo(data.accountNo);
                  setBalance(data.balance);
                }
              } catch(_) { /* 실패해도 비차단 */ }

              if (!uiLocked) {
                setAllInteractiveEnabled(true);     // 전체 활성화
                setStatusPill(false);
                showToast('Failover 완료(Standby 전환)');
              }
              failoverMode = false;
              return;
            }
          }
        } catch (_) { /* 무시 후 재시도 */ }

        await new Promise(r => setTimeout(r, interval));
      }

      showToast('Failover 지연 · 상태 전환을 확인하지 못했습니다');
      failoverMode = false;
    }

    // ---- /ui/status 폴링 : 백엔드 전환 락(LOCK/UNLOCK)에 반응 ----
    async function pollUiLockStatus(){
      try{
        const res  = await fetch('/ui/status', { headers: baseHeaders });
        const data = await res.json().catch(()=> ({}));
        const locked = !!data?.locked;

        if (locked !== uiLocked){
          uiLocked = locked;
          if (uiLocked){
            // 전환 진행 중 잠금
            setAllInteractiveEnabled(false);        // 전체 비활성화
            setStatusPill(true, '시스템 전환 중', '잠시만 기다려 주세요.');
          } else {
            // 전환 해제
            // failoverMode가 아니면 배너 내리고 버튼 활성화
            if (!failoverMode) {
              setAllInteractiveEnabled(true);       // 전체 활성화
              setStatusPill(false);
              showToast('전환 완료');
            }
          }
        }
      }catch(_){ /* 폴링 실패는 조용히 무시 */ }
    }

    async function ctrlActiveDb(act){
      const url = act === 'down' ? '/bank/active-db/down' : '/bank/active-db/up';
      try{
        const res  = await fetch(url, {method:'POST', headers: baseHeaders});
        const data = await res.json().catch(()=> ({}));
        if (!res.ok || data.ok === false) throw new Error(data.message || '요청 실패');

        showToast(data.message || '완료');

        if (act === 'down'){
          // 다운 → Failover 완료 대기: 전체 비활성화
          waitForFailoverAndEnable();
        } else {
          // ⬆️ 업 클릭 시: 현재 standby 상태라면 Up/Down만 선제 비활성화
          try {
            const stRes = await fetch('/bank/failover/status', { headers: baseHeaders });
            if (stRes.ok) {
              const st = await stRes.json().catch(()=> ({}));
              const watcher = String(st?.watcher || '').toLowerCase();
              if (watcher === 'standby') {
                // 🔒 부분 비활성화: DB 제어 버튼만 막기
                setDbControlsEnabled(false);
                setStatusPill(true, '전환 준비 중', 'Active 복구 단계입니다.');
                // 이후 manager가 /ui/status=locked 로 바꾸면 pollUiLockStatus가 전체 비활성화로 전환
              }
            }
          } catch(_) {}

          // 잔액은 살짝 지연 후 갱신(선택)
          setTimeout(()=> loadBalance(true), 700);
        }
      }catch(e){
        showToast('요청 실패: ' + e.message);
      }
    }

    setInterval(pollUiLockStatus, 500); // 0.5초 간격 폴링
    // 초기 1회 즉시 체크
    pollUiLockStatus();

    // ---- 공통 요청(자동 재시도) ----
    async function requestWithFailover(url, options = {}, labelForToast = '요청') {
      const maxRetries = 4;
      const baseDelay  = 500;
      let attempt = 0;

      while (true) {
        try {
          const res  = await fetch(url, options);
          const data = await res.json().catch(() => ({}));

          // ✅ 비즈니스 실패: 200 + { ok:false } → 배너/재시도 X
          if (res.ok && data && data.ok === false) {
            return data;
          }

          // ✅ DB 장애만 failover 모드
          const isDbFail =
            res.status === 503 || (data && data.error === 'DB_CONNECTION_ERROR');

          if (isDbFail) {
            attempt++;
            if (attempt === 1) {
              failoverMode = true;
              setStatusPill(true, 'Failover 감지', `${labelForToast} 재시도 중…`);
            }
            if (attempt > maxRetries) {
              showToast(`${labelForToast} 실패: DB 장애(재시도 초과)`);
              failoverMode = false;
              throw new Error(data?.message || 'DB 장애');
            }
            const backoff = Math.round(baseDelay * Math.pow(1.6, attempt - 1));
            await new Promise(r => setTimeout(r, backoff));
            continue;
          }

          // ✅ 성공
          if (res.ok) {
            if (!uiLocked) setStatusPill(false); // 잠금 중이면 배너 유지
            failoverMode = false;
            return data;
          }

          // ✅ 기타 4xx/5xx: 재시도/배너 없이
          showToast(data?.message || `${labelForToast} 실패`);
          return data || { ok: false, message: `${labelForToast} 실패` };

        } catch (e) {
          attempt++;
          if (attempt > maxRetries) {
            showToast(`${labelForToast} 실패: ${e.message}`);
            failoverMode = false;
            throw e;
          }
          const backoff = Math.round(baseDelay * Math.pow(1.6, attempt - 1));
          await new Promise(r => setTimeout(r, backoff));
        }
      }
    }

    // ---- 초기/수동 잔액 로드 ----
    async function loadBalance(showMsg){
      try{
        const data = await requestWithFailover('/bank/api/balance', {headers: baseHeaders}, '잔액 조회');
        if (data?.ok) {
          setAccountNo(data.accountNo);
          setBalance(data.balance);
          if (showMsg) showToast('잔액이 업데이트되었습니다.');
        }
      }catch(e){
        /* 실패해도 비차단 */
      }
    }

    // ---- 계좌번호 복사 (아이콘 체크 전환) ----
    function copyAcctNo(){
      const txt = document.getElementById('acctNo')?.textContent?.trim();
      const icon = document.querySelector('#copyBtn i');
      if (!txt || !icon) return;
      navigator.clipboard.writeText(txt).then(()=>{
        icon.classList.replace('bi-clipboard','bi-check2');
        setTimeout(()=> icon.classList.replace('bi-check2','bi-clipboard'), 1200);
      });
    }

    // ---- 거래 폼 바인딩 (비차단 + 자동재시도 + 금액 포맷/정규화) ----
    (function(){
      bindAmountFormatter();

      const dep = document.getElementById('formDeposit');
      const wd  = document.getElementById('formWithdraw');
      const trf = document.getElementById('formTransfer');

      if(dep) dep.addEventListener('submit', async e=>{
        e.preventDefault();
        dep.querySelector('#depRequestId').value = rid('DEP');

        const amtInput = dep.querySelector('input[name="amount"]');
        const amount   = parseAmount(amtInput.value);
        if (!amount || amount <= 0){ showToast('입금 금액을 올바르게 입력하세요.'); return; }

        amtInput.value = String(amount);
        const fd = new FormData(dep);
        try{
          const data = await requestWithFailover('/bank/api/deposit', {method:'POST', headers: baseHeaders, body: fd}, '입금');
          if (data?.ok) {
            setBalance(data.balance);
            showToast(data.message || '입금 완료');
            dep.reset();
            bindAmountFormatter();
          } else if (data?.message) {
            showToast(data.message);
          }
        }catch{ /* 실패해도 비차단 */ }
      });

      if(wd) wd.addEventListener('submit', async e=>{
        e.preventDefault();
        wd.querySelector('#wdRequestId').value = rid('WD');

        const amtInput = wd.querySelector('input[name="amount"]');
        const amount   = parseAmount(amtInput.value);
        if (!amount || amount <= 0){ showToast('출금 금액을 올바르게 입력하세요.'); return; }

        amtInput.value = String(amount);
        const fd = new FormData(wd);
        try{
          const data = await requestWithFailover('/bank/api/withdraw', {method:'POST', headers: baseHeaders, body: fd}, '출금');
          if (data?.ok === false){
            showToast(data.message || '출금 실패');
            return;
          }
          if (data?.ok){
            setBalance(data.balance);
            showToast(data.message || '출금 완료');
            wd.reset();
            bindAmountFormatter();
          }
        }catch{ /* 실패해도 비차단 */ }
      });

      if(trf) trf.addEventListener('submit', async e=>{
        e.preventDefault();
        trf.querySelector('#trfRequestId').value = rid('TRF');

        const amtInput = trf.querySelector('input[name="amount"]');
        const amount   = parseAmount(amtInput.value);
        if (!amount || amount <= 0){ showToast('송금 금액을 올바르게 입력하세요.'); return; }

        amtInput.value = String(amount);
        const fd = new FormData(trf);
        try{
          const data = await requestWithFailover('/bank/api/transfer', {method:'POST', headers: baseHeaders, body: fd}, '송금');
          if (data?.ok === false){
            showToast(data.message || '송금 실패');
            return;
          }
          if (data?.ok){
            setBalance(data.balance);
            showToast(data.message || '송금 완료');
            trf.reset();
            bindAmountFormatter();
          }
        }catch{ /* 실패해도 비차단 */ }
      });
    })();

    // 최초 진입 시 잔액 로드
    loadBalance(false);
</script>
</body>
</html>