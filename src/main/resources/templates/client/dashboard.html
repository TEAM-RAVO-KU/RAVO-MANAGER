<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RAVO MySQL Real-time Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <style>
    body { background-color: #f8f9fa; font-family: 'Segoe UI', Arial, sans-serif; }
    h2 { font-weight: 700; color: #0d6efd; margin-bottom: 1rem; }
    .control-panel button { margin: 0.3rem; border-radius: 10px; font-weight: 600; width: 220px; }
    .card { border: none; border-radius: 12px; box-shadow: 0 3px 10px rgba(0,0,0,0.05); margin-bottom: 1rem; }
    .card-header { font-weight: 600; background-color: #e9ecef; border-bottom: 1px solid #dee2e6; }
    .status-up { background-color: #198754; color: white; border-radius: 10px; padding: 0.4rem 0.8rem; }
    .status-down { background-color: #dc3545; color: white; border-radius: 10px; padding: 0.4rem 0.8rem; }
    .chart-container { position: relative; height: 220px; }
    .progress { height: 20px; border-radius: 10px; }
    .footer-text { text-align: center; margin-top: 2rem; color: #6c757d; font-size: 0.9rem; }
    .display-5 { font-size: 2rem; font-weight: 500; }
  </style>
</head>
<body>

<div class="container mt-4">
  <h2 class="text-center mb-4"><i class="bi bi-speedometer2 me-2"></i>RAVO MySQL Real-time Dashboard</h2>

  <!-- ✅ 상단 제어 패널 -->
  <div class="text-center mb-4 control-panel">
    <form method="post" action="/client/admin/db-off" class="d-inline">
      <button type="submit" class="btn btn-danger"><i class="bi bi-power me-1"></i> Active DB Off</button>
    </form>
    <form method="post" action="/client/admin/db-on" class="d-inline">
      <button type="submit" class="btn btn-success"><i class="bi bi-play-circle me-1"></i> Active DB On</button>
    </form>
    <form method="post" action="/client/admin/mock-tx" class="d-inline">
      <button type="submit" class="btn btn-primary"><i class="bi bi-activity me-1"></i> Create Mock Transaction (Start / Stop)</button>
    </form>
  </div>

  <!-- 로그 + 동기화 상태 나란히 -->
  <div class="row justify-content-center align-items-start mb-4">
    <!-- 데이터 동기화 상태 -->
    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-body text-center">
          <h5 class="mb-2"><i class="bi bi-arrow-repeat me-2"></i>데이터 동기화 상태</h5>
          <p class="mb-1">
            Active → Standby 데이터 일치율:
            <strong id="sync-percent" th:text="${syncPercent}">5%</strong>
          </p>
          <div class="progress mb-3" style="height: 25px;">
            <div id="sync-progress-bar"
                 class="progress-bar progress-bar-striped"
                 role="progressbar"
                 style="width: 5%; background-color: #4da3ff; transition: width 0.5s ease-in-out;">
              5%
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- 최근 거래 로그 -->
    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-light">
          <i class="bi bi-list-ul me-1"></i> Mock Transaction Logs
        </div>
        <div class="card-body p-2" style="max-height: 200px; overflow-y: auto;">
          <ul id="mock-log-list" class="list-unstyled mb-0 small" style="font-family: 'Courier New', monospace;">
            <!-- JavaScript가 여기에 로그 append -->
            <li class="text-muted">Waiting for mock transactions...</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <div class="container-fluid mt-4">
    <div class="row">
      <div>Last Updated: <span id="last-updated-time" class="fw-bold"></span></div>
      <div class="col-lg-6" th:with="type='active', data=${initialData.active}">
        <h2 class="h4 mb-3" th:text="${data.dbName} + ' Database'"></h2>
        <div class="row">
          <div class="col-4"><div class="card" th:id="${type} + '-status-card'"><div class="card-body text-center"><h5 class="card-title">Status</h5><p class="display-5" th:id="${type} + '-status-text'"></p></div></div></div>
          <div class="col-4"><div class="card"><div class="card-body text-center"><h5 class="card-title">Uptime</h5><p class="display-5" th:id="${type} + '-uptime'"></p></div></div></div>
          <div class="col-4"><div class="card"><div class="card-body text-center"><h5 class="card-title">Connections</h5><p class="display-5" th:id="${type} + '-threads'"></p></div></div></div>
        </div>
        <div class="row">
          <div class="col-md-6"><div class="card"><div class="card-header">🚀 QPS (Queries/sec)</div><div class="card-body"><div class="chart-container"><canvas th:id="${type} + '-qps-chart'"></canvas></div></div></div></div>
          <div class="col-md-6"><div class="card"><div class="card-header">💻 CPU Usage (cores/sec)</div><div class="card-body"><div class="chart-container"><canvas th:id="${type} + '-cpu-chart'"></canvas></div></div></div></div>
        </div>
        <div class="row">
          <div class="col-md-6"><div class="card"><div class="card-header">🧠 Heap Memory Usage</div><div class="card-body"><div class="chart-container"><canvas th:id="${type} + '-memory-chart'"></canvas></div></div></div></div>
          <div class="col-md-6"><div class="card"><div class="card-header">🌐 Network (bytes/sec)</div><div class="card-body"><div class="chart-container"><canvas th:id="${type} + '-network-chart'"></canvas></div></div></div></div>
        </div>
        <div class="card">
          <div class="card-header">📊 Database Information</div>
          <div class="card-body p-2"><table class="table table-sm table-striped mb-0"><tbody>
          <tr><td>MySQL Version</td><td class="info-value" th:id="${type} + '-mysql-version'"></td></tr>
          <tr><td>Running Threads</td><td class="info-value" th:id="${type} + '-threads-running'"></td></tr>
          <tr><td>Buffer Pool Hit Rate</td><td class="info-value" th:id="${type} + '-buffer-pool-rate'"></td></tr>
          <tr><td>Exporter Go Version</td><td class="info-value" th:id="${type} + '-go-version'"></td></tr>
          </tbody></table></div>
        </div>
      </div>
      <div class="col-lg-6" th:with="type='standby', data=${initialData.standby}">
        <h2 class="h4 mb-3" th:text="${data.dbName} + ' Database'"></h2>
        <div class="row">
          <div class="col-4"><div class="card" th:id="${type} + '-status-card'"><div class="card-body text-center"><h5 class="card-title">Status</h5><p class="display-5" th:id="${type} + '-status-text'"></p></div></div></div>
          <div class="col-4"><div class="card"><div class="card-body text-center"><h5 class="card-title">Uptime</h5><p class="display-5" th:id="${type} + '-uptime'"></p></div></div></div>
          <div class="col-4"><div class="card"><div class="card-body text-center"><h5 class="card-title">Connections</h5><p class="display-5" th:id="${type} + '-threads'"></p></div></div></div>
        </div>
        <div class="row">
          <div class="col-md-6"><div class="card"><div class="card-header">🚀 QPS (Queries/sec)</div><div class="card-body"><div class="chart-container"><canvas th:id="${type} + '-qps-chart'"></canvas></div></div></div></div>
          <div class="col-md-6"><div class="card"><div class="card-header">💻 CPU Usage (cores/sec)</div><div class="card-body"><div class="chart-container"><canvas th:id="${type} + '-cpu-chart'"></canvas></div></div></div></div>
        </div>
        <div class="row">
          <div class="col-md-6"><div class="card"><div class="card-header">🧠 Heap Memory Usage</div><div class="card-body"><div class="chart-container"><canvas th:id="${type} + '-memory-chart'"></canvas></div></div></div></div>
          <div class="col-md-6"><div class="card"><div class="card-header">🌐 Network (bytes/sec)</div><div class="card-body"><div class="chart-container"><canvas th:id="${type} + '-network-chart'"></canvas></div></div></div></div>
        </div>
        <div class="card">
          <div class="card-header">📊 Database Information</div>
          <div class="card-body p-2"><table class="table table-sm table-striped mb-0"><tbody>
          <tr><td>MySQL Version</td><td class="info-value" th:id="${type} + '-mysql-version'"></td></tr>
          <tr><td>Running Threads</td><td class="info-value" th:id="${type} + '-threads-running'"></td></tr>
          <tr><td>Buffer Pool Hit Rate</td><td class="info-value" th:id="${type} + '-buffer-pool-rate'"></td></tr>
          <tr><td>Exporter Go Version</td><td class="info-value" th:id="${type} + '-go-version'"></td></tr>
          </tbody></table></div>
        </div>
      </div>
    </div>
  </div>

  <div class="footer-text">© 2025 RAVO Manager • Unified DR Simulation Dashboard</div>
</div>

<script th:inline="javascript">
  /*<![CDATA[*/
  const initialData = /*[[${initialData}]]*/ {};
  let charts = {};
  let lastMetricsData = {
    active: { timestamp: 0, metrics: {} },
    standby: { timestamp: 0, metrics: {} }
  };

  document.addEventListener('DOMContentLoaded', () => {
    initDashboard();
    // 5초마다 한번씩 갱싱
    setInterval(fetchAndUpdate, 5000);
    // 2초마다 로그 새로고침
    setInterval(() => {
      fetchMockLogs();
      fetchSyncStatus();
    }, 3000);
  });

  function initDashboard() {
    updateLastUpdatedTime();
    ['active', 'standby'].forEach(type => {
      const data = initialData[type];
      if (data) {
        initCharts(type);
        updateDashboardUI(type, data);
        lastMetricsData[type] = { timestamp: Date.now(), metrics: data.metrics || {} };
      }
    });
  }

  function initCharts(type) {
    const commonBarOptions = { maintainAspectRatio: false, animation: false, scales: { y: { beginAtZero: true } } };
    const commonDoughnutOptions = { maintainAspectRatio: false, animation: false };
    const commonLineOptions = { maintainAspectRatio: false, animation: false, scales: { y: { beginAtZero: true }, x: { ticks: { display: false } } }, plugins: { legend: { display: true } }};
    const CHART_DATA_POINTS = 30;

    const qpsCtx = document.getElementById(`${type}-qps-chart`).getContext('2d');
    charts[`${type}-qps`] = new Chart(qpsCtx, {
      type: 'bar', data: { labels: ['SELECT', 'INSERT', 'UPDATE', 'DELETE'], datasets: [
          { label: 'Queries/sec', data: [0, 0, 0, 0], backgroundColor: ['rgba(54, 162, 235, 0.7)', 'rgba(75, 192, 192, 0.7)', 'rgba(255, 206, 86, 0.7)', 'rgba(255, 99, 132, 0.7)'] }
        ]}, options: { ...commonBarOptions, plugins: { legend: { display: false } } }
    });

    const cpuCtx = document.getElementById(`${type}-cpu-chart`).getContext('2d');
    charts[`${type}-cpu`] = new Chart(cpuCtx, {
      type: 'line', data: { labels: Array(CHART_DATA_POINTS).fill(''), datasets: [
          { label: 'cores/sec', data: Array(CHART_DATA_POINTS).fill(0), borderColor: 'rgba(153, 102, 255, 1)', backgroundColor: 'rgba(153, 102, 255, 0.2)', fill: true, tension: 0.2 }
        ]}, options: commonLineOptions
    });

    const memCtx = document.getElementById(`${type}-memory-chart`).getContext('2d');
    charts[`${type}-memory`] = new Chart(memCtx, {
      type: 'doughnut', data: { labels: ['In Use (bytes)', 'Free (bytes)'], datasets: [
          { data: [0, 1], backgroundColor: ['rgb(255, 159, 64)', 'rgb(201, 203, 207)'] }
        ]}, options: commonDoughnutOptions
    });

    const networkCtx = document.getElementById(`${type}-network-chart`).getContext('2d');
    charts[`${type}-network`] = new Chart(networkCtx, {
      type: 'line', data: { labels: Array(CHART_DATA_POINTS).fill(''), datasets: [
          { label: 'Sent', data: Array(CHART_DATA_POINTS).fill(0), borderColor: 'rgba(255, 99, 132, 1)', backgroundColor: 'rgba(255, 99, 132, 0.2)', fill: true, tension: 0.2 },
          { label: 'Received', data: Array(CHART_DATA_POINTS).fill(0), borderColor: 'rgba(54, 162, 235, 1)', backgroundColor: 'rgba(54, 162, 235, 0.2)', fill: true, tension: 0.2 }
        ]}, options: commonLineOptions
    });
  }

  async function fetchAndUpdate() {
    try {
      const response = await fetch('/api/metrics');
      if (!response.ok) return;
      const newData = await response.json();
      updateLastUpdatedTime();
      ['active', 'standby'].forEach(type => {
        if (newData[type]) updateDashboardUI(type, newData[type]);
      });
    } catch (error) { /* ignore */ }
  }

  function updateLastUpdatedTime() {
    document.getElementById('last-updated-time').innerText = new Date().toLocaleTimeString('en-GB');
  }

  function formatUptime(s) {
    if (!s || s <= 0) return '00:00:00';
    return new Date(s * 1000).toISOString().slice(11, 19);
  }

  function calculateRate(type, key, currentValue) {
    const lastData = lastMetricsData[type];
    if (!lastData || !lastData.metrics) return 0;
    const lastValue = lastData.metrics[key] || 0;
    const timeDelta = (Date.now() - lastData.timestamp) / 1000;
    if (currentValue >= lastValue && timeDelta > 0) {
      return (currentValue - lastValue) / timeDelta;
    }
    return 0;
  }

  function updateTimeSeriesChart(chart, newValues) {
    const newLabel = new Date().toLocaleTimeString('en-GB').split(' ')[0];
    chart.data.labels.push(newLabel);
    chart.data.labels.shift();
    chart.data.datasets.forEach((dataset, i) => {
      dataset.data.push(newValues[i] ?? 0);
      dataset.data.shift();
    });
    chart.update('none');
  }

  function updateDashboardUI(type, data) {
    const metrics = data.metrics || {};
    const info = data.info || {};

    const statusCard = document.getElementById(`${type}-status-card`), statusText = document.getElementById(`${type}-status-text`);
    statusCard.className = 'card text-center';
    statusText.innerText = data.status === 'UP' ? '● UP' : '● DOWN';
    statusCard.classList.add(data.status === 'UP' ? 'status-up' : 'status-down');

    document.getElementById(`${type}-uptime`).innerText = formatUptime(metrics.mysql_global_status_uptime);
    document.getElementById(`${type}-threads`).innerText = metrics.mysql_global_status_threads_connected?.toFixed(0) ?? 'N/A';
    document.getElementById(`${type}-mysql-version`).innerText = info.mysql_version_info_version ?? 'N/A';
    document.getElementById(`${type}-threads-running`).innerText = metrics.mysql_global_status_threads_running?.toFixed(0) ?? 'N/A';
    document.getElementById(`${type}-go-version`).innerText = info.go_info_version ?? 'N/A';

    const qpsData = ['select', 'insert', 'update', 'delete'].map(cmd =>
            calculateRate(type, `mysql_global_status_commands_total_${cmd}`, metrics[`mysql_global_status_commands_total_${cmd}`] || 0)
    );
    const networkData = [
      calculateRate(type, 'mysql_global_status_bytes_sent', metrics.mysql_global_status_bytes_sent || 0),
      calculateRate(type, 'mysql_global_status_bytes_received', metrics.mysql_global_status_bytes_received || 0)
    ];
    const cpuRate = calculateRate(type, 'process_cpu_seconds_total', metrics.process_cpu_seconds_total || 0);

    charts[`${type}-qps`].data.datasets[0].data = qpsData;
    charts[`${type}-qps`].update('none');

    updateTimeSeriesChart(charts[`${type}-cpu`], [cpuRate]);
    updateTimeSeriesChart(charts[`${type}-network`], networkData);

    const heapInUse = metrics.go_memstats_heap_inuse_bytes ?? 0;
    const heapSys = metrics.go_memstats_heap_sys_bytes ?? 0;
    charts[`${type}-memory`].data.datasets[0].data = [heapInUse, Math.max(0, heapSys - heapInUse)];
    charts[`${type}-memory`].update('none');

    const readRequestsRate = calculateRate(type, 'mysql_global_status_innodb_buffer_pool_read_requests', metrics.mysql_global_status_innodb_buffer_pool_read_requests);
    const readsRate = calculateRate(type, 'mysql_global_status_innodb_buffer_pool_reads', metrics.mysql_global_status_innodb_buffer_pool_reads);
    const hitRate = readRequestsRate > 0 ? 100 * (1 - (readsRate / readRequestsRate)) : 100;
    document.getElementById(`${type}-buffer-pool-rate`).innerText = `${hitRate.toFixed(2)}%`;

    lastMetricsData[type] = { timestamp: Date.now(), metrics: metrics };
  }

  async function fetchMockLogs() {
    try {
      const res = await fetch('/client/api/mock-logs');
      if (!res.ok) return;
      const logs = await res.json();

      const list = document.getElementById('mock-log-list');
      list.innerHTML = '';

      logs.forEach((log, idx) => {
        const li = document.createElement('li');
        li.textContent = log;
        li.className = idx === 0 ? 'text-primary fw-bold' : 'text-secondary';
        list.appendChild(li);
      });
    } catch (err) {
      console.warn('[MockLogs] fetch error:', err);
    }
  }

  async function fetchSyncStatus() {
    try {
      const response = await fetch('/client/api/sync-status');
      if (!response.ok) return;

      const data = await response.json();
      const syncPercent = data.syncPercent ?? 0;

      // 텍스트 업데이트
      document.getElementById("sync-percent").innerText =
              `Active ↔ Standby 데이터 일치율: ${syncPercent.toFixed(2)}%`;

      // 게이지바 업데이트
      const bar = document.getElementById("sync-progress-bar");
      bar.style.width = `${syncPercent}%`;
      bar.innerText = `${syncPercent.toFixed(2)}%`;
      bar.style.backgroundColor = "#4da3ff"; // 통일된 블루톤
    } catch (e) {
      console.error("❌ Sync status fetch failed", e);
    }
  }
</script>
</body>
</html>
