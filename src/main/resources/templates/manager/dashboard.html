<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAVO MySQL Real-time Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        body { background-color: #f8f9fa; font-size: 0.9rem; }
        .card { margin-bottom: 1.5rem; box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,.075); border: none; }
        .card-header { font-weight: bold; background-color: #e9ecef; border-bottom: 1px solid #dee2e6; }
        .status-up { background-color: #198754; color: white; }
        .status-down { background-color: #dc3545; color: white; }
        .chart-container { position: relative; height: 230px; width: 100%; }
        .info-value { font-weight: 500; }
        .display-5 { font-weight: 500; font-size: 2.2rem; }
    </style>
</head>
<body>
<div class="container-fluid mt-4">
    <header class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom">
        <h1 class="h3">üëë RAVO MySQL Real-time Dashboard</h1>
        <div>Last Updated: <span id="last-updated-time" class="fw-bold"></span></div>
    </header>
    <div class="row">
        <div class="col-lg-6" th:with="type='active', data=${initialData.active}">
            <h2 class="h4 mb-3" th:text="${data.dbName} + ' Database'"></h2>
            <div class="row">
                <div class="col-4"><div class="card" th:id="${type} + '-status-card'"><div class="card-body text-center"><h5 class="card-title">Status</h5><p class="display-5" th:id="${type} + '-status-text'"></p></div></div></div>
                <div class="col-4"><div class="card"><div class="card-body text-center"><h5 class="card-title">Uptime</h5><p class="display-5" th:id="${type} + '-uptime'"></p></div></div></div>
                <div class="col-4"><div class="card"><div class="card-body text-center"><h5 class="card-title">Connections</h5><p class="display-5" th:id="${type} + '-threads'"></p></div></div></div>
            </div>
            <div class="row">
                <div class="col-md-6"><div class="card"><div class="card-header">üöÄ QPS (Queries/sec)</div><div class="card-body"><div class="chart-container"><canvas th:id="${type} + '-qps-chart'"></canvas></div></div></div></div>
                <div class="col-md-6"><div class="card"><div class="card-header">üíª CPU Usage (cores/sec)</div><div class="card-body"><div class="chart-container"><canvas th:id="${type} + '-cpu-chart'"></canvas></div></div></div></div>
            </div>
            <div class="row">
                <div class="col-md-6"><div class="card"><div class="card-header">üß† Heap Memory Usage</div><div class="card-body"><div class="chart-container"><canvas th:id="${type} + '-memory-chart'"></canvas></div></div></div></div>
                <div class="col-md-6"><div class="card"><div class="card-header">üåê Network (bytes/sec)</div><div class="card-body"><div class="chart-container"><canvas th:id="${type} + '-network-chart'"></canvas></div></div></div></div>
            </div>
            <div class="card">
                <div class="card-header">üìä Database Information</div>
                <div class="card-body p-2"><table class="table table-sm table-striped mb-0"><tbody>
                <tr><td>MySQL Version</td><td class="info-value" th:id="${type} + '-mysql-version'"></td></tr>
                <tr><td>Running Threads</td><td class="info-value" th:id="${type} + '-threads-running'"></td></tr>
                <tr><td>Buffer Pool Hit Rate</td><td class="info-value" th:id="${type} + '-buffer-pool-rate'"></td></tr>
                <tr><td>Exporter Go Version</td><td class="info-value" th:id="${type} + '-go-version'"></td></tr>
                </tbody></table></div>
            </div>
        </div>
        <div class="col-lg-6" th:with="type='standby', data=${initialData.standby}">
            <h2 class="h4 mb-3" th:text="${data.dbName} + ' Database'"></h2>
            <div class="row">
                <div class="col-4"><div class="card" th:id="${type} + '-status-card'"><div class="card-body text-center"><h5 class="card-title">Status</h5><p class="display-5" th:id="${type} + '-status-text'"></p></div></div></div>
                <div class="col-4"><div class="card"><div class="card-body text-center"><h5 class="card-title">Uptime</h5><p class="display-5" th:id="${type} + '-uptime'"></p></div></div></div>
                <div class="col-4"><div class="card"><div class="card-body text-center"><h5 class="card-title">Connections</h5><p class="display-5" th:id="${type} + '-threads'"></p></div></div></div>
            </div>
            <div class="row">
                <div class="col-md-6"><div class="card"><div class="card-header">üöÄ QPS (Queries/sec)</div><div class="card-body"><div class="chart-container"><canvas th:id="${type} + '-qps-chart'"></canvas></div></div></div></div>
                <div class="col-md-6"><div class="card"><div class="card-header">üíª CPU Usage (cores/sec)</div><div class="card-body"><div class="chart-container"><canvas th:id="${type} + '-cpu-chart'"></canvas></div></div></div></div>
            </div>
            <div class="row">
                <div class="col-md-6"><div class="card"><div class="card-header">üß† Heap Memory Usage</div><div class="card-body"><div class="chart-container"><canvas th:id="${type} + '-memory-chart'"></canvas></div></div></div></div>
                <div class="col-md-6"><div class="card"><div class="card-header">üåê Network (bytes/sec)</div><div class="card-body"><div class="chart-container"><canvas th:id="${type} + '-network-chart'"></canvas></div></div></div></div>
            </div>
            <div class="card">
                <div class="card-header">üìä Database Information</div>
                <div class="card-body p-2"><table class="table table-sm table-striped mb-0"><tbody>
                <tr><td>MySQL Version</td><td class="info-value" th:id="${type} + '-mysql-version'"></td></tr>
                <tr><td>Running Threads</td><td class="info-value" th:id="${type} + '-threads-running'"></td></tr>
                <tr><td>Buffer Pool Hit Rate</td><td class="info-value" th:id="${type} + '-buffer-pool-rate'"></td></tr>
                <tr><td>Exporter Go Version</td><td class="info-value" th:id="${type} + '-go-version'"></td></tr>
                </tbody></table></div>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const initialData = /*[[${initialData}]]*/ {};
    let charts = {};
    let lastMetricsData = {
        active: { timestamp: 0, metrics: {} },
        standby: { timestamp: 0, metrics: {} }
    };

    document.addEventListener('DOMContentLoaded', () => {
        initDashboard();
        // 5Ï¥àÎßàÎã§ ÌïúÎ≤àÏî© Í∞±Ïã±
        setInterval(fetchAndUpdate, 5000);
    });

    function initDashboard() {
        updateLastUpdatedTime();
        ['active', 'standby'].forEach(type => {
            const data = initialData[type];
            if (data) {
                initCharts(type);
                updateDashboardUI(type, data);
                lastMetricsData[type] = { timestamp: Date.now(), metrics: data.metrics || {} };
            }
        });
    }

    function initCharts(type) {
        const commonBarOptions = { maintainAspectRatio: false, animation: false, scales: { y: { beginAtZero: true } } };
        const commonDoughnutOptions = { maintainAspectRatio: false, animation: false };
        const commonLineOptions = { maintainAspectRatio: false, animation: false, scales: { y: { beginAtZero: true }, x: { ticks: { display: false } } }, plugins: { legend: { display: true } }};
        const CHART_DATA_POINTS = 30;

        const qpsCtx = document.getElementById(`${type}-qps-chart`).getContext('2d');
        charts[`${type}-qps`] = new Chart(qpsCtx, {
            type: 'bar', data: { labels: ['SELECT', 'INSERT', 'UPDATE', 'DELETE'], datasets: [
                    { label: 'Queries/sec', data: [0, 0, 0, 0], backgroundColor: ['rgba(54, 162, 235, 0.7)', 'rgba(75, 192, 192, 0.7)', 'rgba(255, 206, 86, 0.7)', 'rgba(255, 99, 132, 0.7)'] }
                ]}, options: { ...commonBarOptions, plugins: { legend: { display: false } } }
        });

        const cpuCtx = document.getElementById(`${type}-cpu-chart`).getContext('2d');
        charts[`${type}-cpu`] = new Chart(cpuCtx, {
            type: 'line', data: { labels: Array(CHART_DATA_POINTS).fill(''), datasets: [
                    { label: 'cores/sec', data: Array(CHART_DATA_POINTS).fill(0), borderColor: 'rgba(153, 102, 255, 1)', backgroundColor: 'rgba(153, 102, 255, 0.2)', fill: true, tension: 0.2 }
                ]}, options: commonLineOptions
        });

        const memCtx = document.getElementById(`${type}-memory-chart`).getContext('2d');
        charts[`${type}-memory`] = new Chart(memCtx, {
            type: 'doughnut', data: { labels: ['In Use (bytes)', 'Free (bytes)'], datasets: [
                    { data: [0, 1], backgroundColor: ['rgb(255, 159, 64)', 'rgb(201, 203, 207)'] }
                ]}, options: commonDoughnutOptions
        });

        const networkCtx = document.getElementById(`${type}-network-chart`).getContext('2d');
        charts[`${type}-network`] = new Chart(networkCtx, {
            type: 'line', data: { labels: Array(CHART_DATA_POINTS).fill(''), datasets: [
                    { label: 'Sent', data: Array(CHART_DATA_POINTS).fill(0), borderColor: 'rgba(255, 99, 132, 1)', backgroundColor: 'rgba(255, 99, 132, 0.2)', fill: true, tension: 0.2 },
                    { label: 'Received', data: Array(CHART_DATA_POINTS).fill(0), borderColor: 'rgba(54, 162, 235, 1)', backgroundColor: 'rgba(54, 162, 235, 0.2)', fill: true, tension: 0.2 }
                ]}, options: commonLineOptions
        });
    }

    async function fetchAndUpdate() {
        try {
            const response = await fetch('/api/metrics');
            if (!response.ok) return;
            const newData = await response.json();
            updateLastUpdatedTime();
            ['active', 'standby'].forEach(type => {
                if (newData[type]) updateDashboardUI(type, newData[type]);
            });
        } catch (error) { /* ignore */ }
    }

    function updateLastUpdatedTime() {
        document.getElementById('last-updated-time').innerText = new Date().toLocaleTimeString('en-GB');
    }

    function formatUptime(s) {
        if (!s || s <= 0) return '00:00:00';
        return new Date(s * 1000).toISOString().slice(11, 19);
    }

    function calculateRate(type, key, currentValue) {
        const lastData = lastMetricsData[type];
        if (!lastData || !lastData.metrics) return 0;
        const lastValue = lastData.metrics[key] || 0;
        const timeDelta = (Date.now() - lastData.timestamp) / 1000;
        if (currentValue >= lastValue && timeDelta > 0) {
            return (currentValue - lastValue) / timeDelta;
        }
        return 0;
    }

    function updateTimeSeriesChart(chart, newValues) {
        const newLabel = new Date().toLocaleTimeString('en-GB').split(' ')[0];
        chart.data.labels.push(newLabel);
        chart.data.labels.shift();
        chart.data.datasets.forEach((dataset, i) => {
            dataset.data.push(newValues[i] ?? 0);
            dataset.data.shift();
        });
        chart.update('none');
    }

    function updateDashboardUI(type, data) {
        const metrics = data.metrics || {};
        const info = data.info || {};

        const statusCard = document.getElementById(`${type}-status-card`), statusText = document.getElementById(`${type}-status-text`);
        statusCard.className = 'card text-center';
        statusText.innerText = data.status === 'UP' ? '‚óè UP' : '‚óè DOWN';
        statusCard.classList.add(data.status === 'UP' ? 'status-up' : 'status-down');

        document.getElementById(`${type}-uptime`).innerText = formatUptime(metrics.mysql_global_status_uptime);
        document.getElementById(`${type}-threads`).innerText = metrics.mysql_global_status_threads_connected?.toFixed(0) ?? 'N/A';
        document.getElementById(`${type}-mysql-version`).innerText = info.mysql_version_info_version ?? 'N/A';
        document.getElementById(`${type}-threads-running`).innerText = metrics.mysql_global_status_threads_running?.toFixed(0) ?? 'N/A';
        document.getElementById(`${type}-go-version`).innerText = info.go_info_version ?? 'N/A';

        const qpsData = ['select', 'insert', 'update', 'delete'].map(cmd =>
            calculateRate(type, `mysql_global_status_commands_total_${cmd}`, metrics[`mysql_global_status_commands_total_${cmd}`] || 0)
        );
        const networkData = [
            calculateRate(type, 'mysql_global_status_bytes_sent', metrics.mysql_global_status_bytes_sent || 0),
            calculateRate(type, 'mysql_global_status_bytes_received', metrics.mysql_global_status_bytes_received || 0)
        ];
        const cpuRate = calculateRate(type, 'process_cpu_seconds_total', metrics.process_cpu_seconds_total || 0);

        charts[`${type}-qps`].data.datasets[0].data = qpsData;
        charts[`${type}-qps`].update('none');

        updateTimeSeriesChart(charts[`${type}-cpu`], [cpuRate]);
        updateTimeSeriesChart(charts[`${type}-network`], networkData);

        const heapInUse = metrics.go_memstats_heap_inuse_bytes ?? 0;
        const heapSys = metrics.go_memstats_heap_sys_bytes ?? 0;
        charts[`${type}-memory`].data.datasets[0].data = [heapInUse, Math.max(0, heapSys - heapInUse)];
        charts[`${type}-memory`].update('none');

        const readRequestsRate = calculateRate(type, 'mysql_global_status_innodb_buffer_pool_read_requests', metrics.mysql_global_status_innodb_buffer_pool_read_requests);
        const readsRate = calculateRate(type, 'mysql_global_status_innodb_buffer_pool_reads', metrics.mysql_global_status_innodb_buffer_pool_reads);
        const hitRate = readRequestsRate > 0 ? 100 * (1 - (readsRate / readRequestsRate)) : 100;
        document.getElementById(`${type}-buffer-pool-rate`).innerText = `${hitRate.toFixed(2)}%`;

        lastMetricsData[type] = { timestamp: Date.now(), metrics: metrics };
    }
    /*]]>*/
</script>
</body>
</html>