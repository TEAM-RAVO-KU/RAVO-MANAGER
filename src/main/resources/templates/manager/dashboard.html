<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAVO MySQL Real-time Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .card { margin-bottom: 1.5rem; box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,.075); }
        .card-header { font-weight: bold; }
        .status-up { background-color: #198754; color: white; }
        .status-down { background-color: #dc3545; color: white; }
        .status-unknown { background-color: #6c757d; color: white; }
        .chart-container { position: relative; height: 250px; width: 100%; }
    </style>
</head>
<body>
<div class="container-fluid mt-4">
    <header class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom">
        <h1 class="h3">👑 RAVO MySQL Real-time Dashboard</h1>
        <div>Last Updated: <span id="last-updated-time"></span></div>
    </header>

    <div class="row">
        <div class="col-lg-6">
            <div th:with="type='active', data=${initialData.active}">
                <h2 class="h4 mb-3" th:text="${data.dbName} + ' Database'"></h2>
            </div>
        </div>

        <div class="col-lg-6">
            <div th:with="type='standby', data=${initialData.standby}">
                <h2 class="h4 mb-3" th:text="${data.dbName} + ' Database'"></h2>
            </div>
        </div>
    </div>
</div>

<div th:fragment="db-column(type, data)">
    <h2 class="h4 mb-3" th:text="${data.dbName} + ' Database'"></h2>
    <div class="row">
        <div class="col-md-6">
            <div class="card" th:id="${type} + '-status-card'">
                <div class="card-body text-center">
                    <h5 class="card-title">Status</h5>
                    <p class="display-4 fw-bold" th:id="${type} + '-status-text'"></p>
                    <span class="fs-1" th:id="${type} + '-status-icon'"></span>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title">Go Routines</h5>
                    <p class="display-4 fw-bold" th:id="${type} + '-goroutines'"></p>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">CPU Usage (cores)</div>
        <div class="card-body">
            <div class="chart-container">
                <canvas th:id="${type} + '-cpu-chart'"></canvas>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">Heap Memory Usage</div>
        <div class="card-body">
            <div class="chart-container">
                <canvas th:id="${type} + '-memory-chart'"></canvas>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">Exporter Information</div>
        <div class="card-body">
            <table class="table table-sm mb-0">
                <tbody>
                <tr>
                    <td>Go Version</td>
                    <td th:id="${type} + '-go-version'"></td>
                </tr>
                <tr>
                    <td>Uptime (seconds)</td>
                    <td th:id="${type} + '-uptime'"></td>
                </tr>
                <tr>
                    <td>Total Queries</td>
                    <td th:id="${type} + '-queries'"></td>
                </tr>
                <tr>
                    <td>Connected Threads</td>
                    <td th:id="${type} + '-threads'"></td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    // --- Changed: 서버에서 받은 initialData를 JavaScript 변수로 초기화 ---
    const initialData = /*[[${initialData}]]*/ {};

    // Global state
    let charts = {};
    let lastCpuData = {
        active: { total: 0, timestamp: 0 },
        standby: { total: 0, timestamp: 0 }
    };

    document.addEventListener('DOMContentLoaded', () => {
        initDashboard();
        setInterval(fetchAndUpdate, 5000);
    });

    function initDashboard() {
        updateLastUpdatedTime();

        ['active', 'standby'].forEach(type => {
            const data = initialData[type];
            if (data) {
                initCharts(type);
                updateDashboardUI(type, data);
            }
        });
    }

    function initCharts(type) {
        // CPU Line Chart
        const cpuCtx = document.getElementById(`${type}-cpu-chart`).getContext('2d');
        charts[`${type}-cpu`] = new Chart(cpuCtx, {
            type: 'line',
            data: {
                labels: Array(12).fill(''),
                datasets: [{
                    label: 'CPU Usage (cores)',
                    data: Array(12).fill(0),
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1,
                    fill: false
                }]
            },
            options: { maintainAspectRatio: false, animation: { duration: 500 } }
        });

        // Memory Donut Chart
        const memCtx = document.getElementById(`${type}-memory-chart`).getContext('2d');
        charts[`${type}-memory`] = new Chart(memCtx, {
            type: 'doughnut',
            data: {
                labels: ['In Use', 'Free'],
                datasets: [{
                    // --- Changed: 비어있는 배열로 초기화 ---
                    data: [0, 1],
                    backgroundColor: ['rgb(255, 99, 132)', 'rgb(201, 203, 207)'],
                }]
            },
            options: { maintainAspectRatio: false, animation: { duration: 500 } }
        });
    }

    async function fetchAndUpdate() {
        try {
            const response = await fetch('/api/metrics');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const newData = await response.json();
            updateLastUpdatedTime();

            ['active', 'standby'].forEach(type => {
                if (newData[type]) {
                    updateDashboardUI(type, newData[type]);
                }
            });

        } catch (error) {
            console.error("Failed to fetch metrics:", error);
        }
    }

    function updateLastUpdatedTime() {
        document.getElementById('last-updated-time').innerText = new Date().toLocaleTimeString();
    }

    function updateDashboardUI(type, data) {
        const statusCard = document.getElementById(`${type}-status-card`);
        const statusText = document.getElementById(`${type}-status-text`);
        const statusIcon = document.getElementById(`${type}-status-icon`);

        statusCard.className = 'card text-center';
        if (data.status === 'UP') {
            statusCard.classList.add('status-up');
            statusText.innerText = 'UP';
            statusIcon.innerText = '✅';
        } else if (data.status === 'DOWN') {
            statusCard.classList.add('status-down');
            statusText.innerText = 'DOWN';
            statusIcon.innerText = '❌';
        } else {
            statusCard.classList.add('status-unknown');
            statusText.innerText = 'UNKNOWN';
            statusIcon.innerText = '❓';
        }

        // --- Changed: || 또는 ?? 연산자로 수정 ---
        const metrics = data.metrics || {};
        const info = data.info || {};
        document.getElementById(`${type}-goroutines`).innerText = metrics.go_goroutines?.toFixed(0) ?? 'N/A';
        document.getElementById(`${type}-go-version`).innerText = info.go_version ?? 'N/A';
        document.getElementById(`${type}-uptime`).innerText = metrics.mysql_global_status_uptime?.toFixed(0) ?? 'N/A';
        document.getElementById(`${type}-queries`).innerText = metrics.mysql_global_status_queries?.toFixed(0) ?? 'N/A';
        document.getElementById(`${type}-threads`).innerText = metrics.mysql_global_status_threads_connected?.toFixed(0) ?? 'N/A';

        // Update CPU Chart
        const cpuChart = charts[`${type}-cpu`];
        const currentCpuTotal = metrics.process_cpu_seconds_total ?? 0;
        const currentTimestamp = Date.now();

        if (lastCpuData[type].total > 0 && lastCpuData[type].timestamp > 0) {
            const timeDelta = (currentTimestamp - lastCpuData[type].timestamp) / 1000;
            const valueDelta = currentCpuTotal - lastCpuData[type].total;
            const cpuRate = timeDelta > 0 ? valueDelta / timeDelta : 0;

            cpuChart.data.datasets[0].data.push(cpuRate.toFixed(4));
            cpuChart.data.datasets[0].data.shift();
            cpuChart.update('none');
        }
        lastCpuData[type] = { total: currentCpuTotal, timestamp: currentTimestamp };

        // Update Memory Chart
        const memChart = charts[`${type}-memory`];
        const heapInUse = metrics.go_memstats_heap_inuse_bytes ?? 0;
        const heapSys = metrics.go_memstats_heap_sys_bytes ?? 0;
        const heapFree = heapSys > heapInUse ? heapSys - heapInUse : 0;

        // --- Changed: 배열로 한 번에 할당 ---
        memChart.data.datasets[0].data = [heapInUse, heapFree];
        memChart.update('none');
    }
    /*]]>*/
</script>
</body>
</html>